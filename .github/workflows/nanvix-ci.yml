name: Nanvix CI

on:
  schedule:
    - cron: "0 0 * * *"
  push:
    branches:
      - nanvix/**
  pull_request:
    branches:
      - nanvix/**
  workflow_dispatch:
  repository_dispatch:
    types: [nanvix-minor-release, nanvix-major-release, cpython-release]

permissions:
  contents: write
  actions: write
  issues: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref_name || github.ref || 'default' }}
  cancel-in-progress: ${{ github.event_name == 'repository_dispatch' }}

jobs:
  get-nanvix-info:
    runs-on: ubuntu-latest
    outputs:
      sha: ${{ steps.extract.outputs.sha }}
      sha_full: ${{ steps.extract.outputs.sha_full }}
    steps:
      - name: Download Nanvix Release Info
        id: extract
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          curl -fsSL https://raw.githubusercontent.com/nanvix/nanvix/refs/heads/dev/scripts/get-nanvix.sh | bash -s -- --force nanvix-artifacts
          ARTIFACT_FILE=$(find nanvix-artifacts -maxdepth 1 -type f -name "*.tar.bz2" | head -1)
          if [[ -z "$ARTIFACT_FILE" ]]; then
            echo "::error::No Nanvix artifact found"
            exit 1
          fi
          NANVIX_SHA_FULL=$(basename "$ARTIFACT_FILE" | sed -E 's/.*-([a-f0-9]{40})\.tar\.bz2$/\1/')
          NANVIX_SHA="${NANVIX_SHA_FULL::7}"
          echo "sha=$NANVIX_SHA" >> "$GITHUB_OUTPUT"
          echo "sha_full=$NANVIX_SHA_FULL" >> "$GITHUB_OUTPUT"

  build:
    needs: get-nanvix-info
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: hyperlight
            process-mode: multi-process
          - platform: hyperlight
            process-mode: single-process
          - platform: microvm
            process-mode: single-process
          - platform: microvm
            process-mode: multi-process
    name: ${{ matrix.platform }}-${{ matrix.process-mode }}
    container:
      image: nanvix/toolchain:latest-minimal
      options: --device /dev/kvm
    defaults:
      run:
        shell: bash
    env:
      NANVIX_SHA: ${{ needs.get-nanvix-info.outputs.sha }}
      NANVIX_SHA_FULL: ${{ needs.get-nanvix-info.outputs.sha_full }}
      USER: runner
    steps:
      - uses: actions/checkout@v4

      - name: Download and Extract Nanvix Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          curl -fsSL https://raw.githubusercontent.com/nanvix/nanvix/refs/heads/dev/scripts/get-nanvix.sh | bash -s -- --force nanvix-artifacts
          ARTIFACT_PATTERN="${{ matrix.platform }}.*${{ matrix.process-mode }}.*\.tar\.bz2"
          ARTIFACT_FILE=$(find nanvix-artifacts -maxdepth 1 -type f -name "*.tar.bz2" | grep -E "$ARTIFACT_PATTERN" | head -1)
          if [[ -z "$ARTIFACT_FILE" ]]; then
            echo "::error::No ${{ matrix.platform }} ${{ matrix.process-mode }} artifact found"
            exit 1
          fi
          mkdir -p nanvix-artifacts/extracted
          tar -xjf "$ARTIFACT_FILE" -C nanvix-artifacts/extracted
          NANVIX_HOME=$(find nanvix-artifacts/extracted -maxdepth 2 -type d -name "bin" -exec dirname {} \; | head -1)
          echo "NANVIX_HOME=$NANVIX_HOME" >> "$GITHUB_ENV"

      - name: Install CPython Headers
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          CPYTHON_ARTIFACT="cpython-${{ matrix.platform }}-${{ matrix.process-mode }}.tar.bz2"
          mkdir -p cpython-dep
          CPYTHON_URL="https://github.com/nanvix/cpython/releases/latest/download/${CPYTHON_ARTIFACT}"
          if curl -fsSL -o "cpython-dep/${CPYTHON_ARTIFACT}" "$CPYTHON_URL"; then
            tar -xjf "cpython-dep/${CPYTHON_ARTIFACT}" -C cpython-dep
            CPYTHON_DIR=$(find cpython-dep -mindepth 1 -maxdepth 1 -type d \( -name "sysroot" -o -name "cpython-*" \) | head -1)
            if [[ -n "$CPYTHON_DIR" ]] && [[ -d "$CPYTHON_DIR" ]]; then
              mkdir -p "$NANVIX_HOME/include"
              cp -rf "$CPYTHON_DIR"/include/* "$NANVIX_HOME/include/" 2>/dev/null || true
              echo "CPython headers installed"
            fi
          else
            echo "::warning::Could not download CPython headers"
          fi

      - name: Build
        run: |
          make -f Makefile.nanvix CONFIG_NANVIX=y NANVIX_HOME="$NANVIX_HOME" NANVIX_TOOLCHAIN="/opt/nanvix" all

      - name: Test
        run: |
          make -f Makefile.nanvix CONFIG_NANVIX=y NANVIX_HOME="$NANVIX_HOME" NANVIX_TOOLCHAIN="/opt/nanvix" test

      - name: Package Artifacts
        run: |
          set -euo pipefail
          ARTIFACT_NAME="srsly-${{ matrix.platform }}-${{ matrix.process-mode }}"
          DIST_DIR="dist/${ARTIFACT_NAME}"
          mkdir -p "${DIST_DIR}/lib"
          cp -f libsrsly_ujson.a "${DIST_DIR}/lib/"
          cp -f libsrsly_msgpack_packer.a "${DIST_DIR}/lib/"
          cp -f libsrsly_msgpack_unpacker.a "${DIST_DIR}/lib/"
          cp -f libsrsly_msgpack_epoch.a "${DIST_DIR}/lib/"
          tar -cjf "dist/${ARTIFACT_NAME}.tar.bz2" -C dist "${ARTIFACT_NAME}"
          echo "ARTIFACT_TARBALL=dist/${ARTIFACT_NAME}.tar.bz2" >> "$GITHUB_ENV"

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: srsly-${{ matrix.platform }}-${{ matrix.process-mode }}
          path: ${{ env.ARTIFACT_TARBALL }}
          retention-days: 7

  release:
    needs: [get-nanvix-info, build]
    if: github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    env:
      NANVIX_SHA: ${{ needs.get-nanvix-info.outputs.sha }}
      NANVIX_SHA_FULL: ${{ needs.get-nanvix-info.outputs.sha_full }}
    steps:
      - uses: actions/checkout@v4

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts
          pattern: srsly-*

      - name: Prepare Release Assets
        run: |
          set -euo pipefail
          mkdir -p release-assets
          find release-artifacts -name "*.tar.bz2" -exec cp {} release-assets/ \;
          ls -la release-assets/

      - name: Get Nanvix Release Info
        id: nanvix-release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          API_URL="https://api.github.com/repos/nanvix/nanvix/releases/tags/latest"
          RELEASE_INFO=$(curl -fsSL -H "Authorization: Bearer ${GH_TOKEN}" "$API_URL")
          NANVIX_NAME=$(echo "$RELEASE_INFO" | jq -r '.name // "latest"')
          NANVIX_PUBLISHED=$(echo "$RELEASE_INFO" | jq -r '.published_at')
          echo "name=${NANVIX_NAME}" >> "$GITHUB_OUTPUT"
          echo "published=${NANVIX_PUBLISHED}" >> "$GITHUB_OUTPUT"

      - name: Create Latest Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NANVIX_NAME: ${{ steps.nanvix-release.outputs.name }}
          NANVIX_PUBLISHED: ${{ steps.nanvix-release.outputs.published }}
        run: |
          RELEASE_TAG="${GITHUB_SHA::7}-nanvix-${NANVIX_SHA}"
          if gh release view "$RELEASE_TAG" &>/dev/null; then
            gh release delete "$RELEASE_TAG" --yes --cleanup-tag || true
          fi
          gh release create "$RELEASE_TAG" \
            --title "Build ${GITHUB_SHA::7}" \
            --notes "Automated build from branch ${{ github.ref_name }} at commit ${{ github.sha }}.

          **Build Information:**
          - Workflow Run: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - Commit: [${{ github.sha }}](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})
          - Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")

          **Nanvix Release:**
          - Name: ${NANVIX_NAME}
          - Published: ${NANVIX_PUBLISHED}
          - Commit: [${NANVIX_SHA_FULL}](https://github.com/nanvix/nanvix/commit/${NANVIX_SHA_FULL})

          **Dependencies:**
          - CPython headers (nanvix/cpython)" \
            --latest \
            release-assets/*.tar.bz2

      # Trigger dependent workflows (nanvix-python integration)
      - name: Trigger Dependent Workflows
        if: success()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RELEASE_TAG="${GITHUB_SHA::7}-nanvix-${NANVIX_SHA}"
          echo "Triggering nanvix-python workflow..."
          gh api repos/nanvix/nanvix-python/dispatches \
            -X POST \
            -H "Accept: application/vnd.github+json" \
            -f event_type="srsly-release" \
            -f "client_payload[nanvix_sha]=${NANVIX_SHA}" \
            -f "client_payload[srsly_tag]=${RELEASE_TAG}" || echo "::warning::Failed to trigger nanvix-python workflow"

  report-failure:
    needs: [build]
    if: >-
      ${{ always() &&
          (github.event_name == 'repository_dispatch' || github.event_name == 'schedule' || github.event_name == 'push') &&
          needs.build.result == 'failure' }}
    runs-on: ubuntu-latest
    steps:
      - name: Create failure issue
        uses: actions/github-script@v7
        env:
          BUILD_RESULT: ${{ needs.build.result }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `CI failure (run ${context.runNumber})`,
              body: `The srsly CI workflow failed.\n- Trigger: ${context.eventName}\n- Run: [#${context.runNumber}](${runUrl})\n- SHA: ${context.sha}\n- build: ${process.env.BUILD_RESULT}\n\nPlease investigate.`,
              assignees: ['ppenna']
            });
